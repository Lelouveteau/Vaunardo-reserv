<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Syst√®me de R√©servation Pok√©mon</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Tesseract.js pour OCR c√¥t√© client -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.3/dist/tesseract.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen p-4">

<div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6">
  <h1 class="text-3xl font-bold text-center mb-6 text-purple-600">
    üéÆ Syst√®me de R√©servation Pok√©mon
  </h1>

  <div class="flex justify-center gap-4 mb-6">
    <button onclick="setMode('client')" id="btnClient"
      class="px-6 py-2 rounded-lg font-semibold bg-blue-500 text-white">
      Client
    </button>
    <button onclick="setMode('admin')" id="btnAdmin"
      class="px-6 py-2 rounded-lg font-semibold bg-gray-200">
      Administrateur
    </button>
  </div>

  <div id="clientView">
    <label class="block font-semibold mb-2">Votre pseudo</label>
    <input id="pseudoInput" class="w-full border rounded p-2 mb-4" placeholder="Pseudo">

    <p class="text-sm text-gray-600 mb-2">Choisissez jusqu'√† 2 Pok√©mon</p>
    <div id="pokemonList" class="grid md:grid-cols-3 gap-4 mb-4"></div>

    <button onclick="reservePokemon()"
      class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold">
      Confirmer la r√©servation
    </button>
  </div>

  <div id="adminView" class="hidden space-y-6">
    <div>
      <h2 class="text-xl font-bold text-purple-600 mb-2">Ajouter des Pok√©mon (texte)</h2>
      <textarea id="scanInput" class="w-full border rounded p-2 h-24"
        placeholder="Pikachu 50&#10;Dracaufeu 65"></textarea>
      <button onclick="addPokemon()"
        class="w-full mt-2 bg-purple-500 text-white py-2 rounded">
        Ajouter √† l'inventaire (depuis le texte)
      </button>
    </div>

    <div>
      <h2 class="text-xl font-bold text-purple-600 mb-2">Scanner une image (OCR) pour ajouter</h2>
      <input id="scanImageInput" type="file" accept="image/*" class="mb-2" />
      <div class="flex gap-2">
        <button onclick="scanImage()" id="btnScanImage" class="px-4 py-2 bg-yellow-400 rounded">Scanner l'image</button>
        <div id="ocrStatus" class="text-sm text-gray-600 self-center"></div>
      </div>
      <p class="text-sm text-gray-500 mt-2">L'image sera analys√©e (OCR) et le texte extrait sera interpr√©t√© comme des lignes "<em>Nom Niveau</em>".</p>
    </div>

    <div>
      <h2 class="text-xl font-bold text-purple-600 mb-2">Uploader des images de Pok√©mon</h2>
      <input id="imagesUpload" type="file" accept="image/*" multiple class="mb-2" />
      <button onclick="uploadImages()" class="w-full mt-1 bg-indigo-500 text-white py-2 rounded">Importer et associer aux Pok√©mon</button>
      <p class="text-sm text-gray-500 mt-2">Les fichiers seront associ√©s par nom de fichier (ex: <code>Pikachu.png</code>) aux Pok√©mon existants. Si aucun Pok√©mon correspondant n'est trouv√©, une nouvelle entr√©e sera cr√©√©e.</p>
    </div>

    <div>
      <h2 class="text-xl font-bold text-purple-600 mb-2">Commandes</h2>
      <div id="ordersList" class="space-y-4"></div>
    </div>
  </div>
</div>

<script>
let mode = 'client';
let inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
let orders = JSON.parse(localStorage.getItem('orders') || '[]');
let selected = [];

function save() {
  localStorage.setItem('inventory', JSON.stringify(inventory));
  localStorage.setItem('orders', JSON.stringify(orders));
}

function setMode(m) {
  mode = m;
  document.getElementById('clientView').classList.toggle('hidden', m !== 'client');
  document.getElementById('adminView').classList.toggle('hidden', m !== 'admin');
  render();
}

function render() {
  renderPokemon();
  renderOrders();
}

function renderPokemon() {
  const list = document.getElementById('pokemonList');
  list.innerHTML = '';
  inventory.filter(p => !p.reserved).forEach(p => {
    const div = document.createElement('div');
    div.className = `border p-3 rounded cursor-pointer ${selected.includes(p.id) ? 'border-blue-500 bg-blue-50' : ''}`;
    div.onclick = () => toggleSelect(p.id);

    let inner = '';
    if (p.imageData) {
      inner += `<div class="w-full h-32 flex items-center justify-center mb-2"><img src="${p.imageData}" alt="${escapeHtml(p.name)}" class="max-h-28 object-contain" /></div>`;
    }
    inner += `<b>${escapeHtml(p.name)}</b><br>Niveau ${escapeHtml(String(p.level))}`;
    div.innerHTML = inner;
    list.appendChild(div);
  });
}

function escapeHtml(s) {
  return s.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]; });
}

function toggleSelect(id) {
  if (selected.includes(id)) selected = selected.filter(i => i !== id);
  else if (selected.length < 2) selected.push(id);
  renderPokemon();
}

function reservePokemon() {
  const pseudo = document.getElementById('pseudoInput').value.trim();
  if (!pseudo || selected.length === 0) return alert('Pseudo et Pok√©mon requis');

  // Limite √† 2 Pok√©mon par jour pour un pseudo
  const today = new Date().toLocaleDateString('fr-FR');
  const reservedToday = orders
    .filter(o => o.pseudo === pseudo && o.date === today)
    .reduce((sum, o) => sum + o.pokemon.length, 0);

  if (reservedToday + selected.length > 2) {
    return alert('Vous ne pouvez pas r√©server plus de 2 Pok√©mon par jour.');
  }

  const pokemon = inventory.filter(p => selected.includes(p.id));
  pokemon.forEach(p => p.reserved = true);

  orders.push({ id: Date.now(), pseudo, pokemon, date: today, status: 'pending' });
  selected = [];
  save();
  alert('R√©servation r√©ussie');
  render();
}

// Ajout de Pok√©mon depuis le textarea ou depuis du texte OCR
function addPokemon(text) {
  const raw = (typeof text === 'string') ? text : document.getElementById('scanInput').value;
  raw.split('\n').forEach(l => {
    if (!l.trim()) return;
    // Accept common separators and allow multi-word names (ex: "Dracaufeu 65")
    const parts = l.trim().split(/\s+/);
    const levelCandidate = parts[parts.length - 1];
    let level = parseInt(levelCandidate, 10);
    let name;
    if (!isNaN(level)) {
      name = parts.slice(0, parts.length - 1).join(' ');
    } else {
      // pas de niveau fourni -> niveau par d√©faut 50
      level = 50;
      name = parts.join(' ');
    }
    inventory.push({ id: Date.now() + Math.random(), name: name.trim(), level, reserved: false, imageData: null });
  });
  if (!text) document.getElementById('scanInput').value = '';
  save();
  render();
}

// OCR d'une image s√©lectionn√©e, puis ajout depuis le texte reconnu
async function scanImage() {
  const inp = document.getElementById('scanImageInput');
  const status = document.getElementById('ocrStatus');
  const file = inp.files && inp.files[0];
  if (!file) return alert('S√©lectionnez une image √† scanner');

  status.textContent = 'Analyse en cours...';
  document.getElementById('btnScanImage').disabled = true;

  try {
    const { data: { text } } = await Tesseract.recognize(file, 'fra', {
      logger: m => {
        // m.progress, m.status
        if (m.status === 'recognizing text') {
          status.textContent = 'Reconnaissance: ' + Math.round(m.progress * 100) + '%';
        }
      }
    });
    status.textContent = 'Texte d√©tect√©, ajout au stock...';
    // Nettoyage basique du texte: remplacer multiples espaces, normaliser retours √† la ligne
    const cleaned = text.replace(/\r/g, '\n').split('\n').map(l => l.trim()).filter(Boolean).join('\n');
    addPokemon(cleaned);
    status.textContent = 'Termin√© ‚Äî Pok√©mon ajout√©s depuis l‚Äôimage';
  } catch (e) {
    console.error(e);
    status.textContent = 'Erreur pendant l\'OCR';
    alert('Erreur pendant l\'analyse de l\'image. Voir la console pour d√©tails.');
  } finally {
    document.getElementById('btnScanImage').disabled = false;
    setTimeout(() => status.textContent = '', 3000);
    inp.value = '';
  }
}

// Upload d'images pour associer aux Pok√©mon par nom de fichier
function uploadImages() {
  const files = Array.from(document.getElementById('imagesUpload').files || []);
  if (files.length === 0) return alert('S√©lectionnez une ou plusieurs images');

  let processed = 0;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const dataUrl = e.target.result;
      // Nom sans extension, remplacer _ et - par espace, trim
      const base = file.name.replace(/\.[^/.]+$/, '').replace(/[_-]+/g, ' ').trim();
      const nameLower = base.toLowerCase();

      // Chercher un Pok√©mon existant sans image qui correspond (nom contenu ou √©gal), priorit√© exact match
      let match = inventory.find(i => i.name.toLowerCase() === nameLower);
      if (!match) {
        match = inventory.find(i => i.name.toLowerCase().includes(nameLower) && !i.imageData);
      }
      if (match) {
        match.imageData = dataUrl;
      } else {
        // cr√©er nouvelle entr√©e si aucun match
        inventory.push({ id: Date.now() + Math.random(), name: base, level: 50, reserved: false, imageData: dataUrl });
      }
      processed++;
      if (processed === files.length) {
        save();
        render();
        document.getElementById('imagesUpload').value = '';
        alert('Images import√©es et associ√©es.');
      }
    };
    reader.readAsDataURL(file);
  });
}

function renderOrders() {
  const list = document.getElementById('ordersList');
  list.innerHTML = '';
  orders.forEach(o => {
    const div = document.createElement('div');
    div.className = 'border rounded p-4';
    div.innerHTML = `<b>${escapeHtml(o.pseudo)}</b> (${escapeHtml(o.status)})<br>
      ${o.pokemon.map(p => `‚Ä¢ ${escapeHtml(p.name)} niv.${escapeHtml(String(p.level))}`).join('<br>')}
      <div class="mt-2">
        <button onclick="toggleStatus(${o.id})" class="px-3 py-1 bg-green-100 rounded mr-2">Changer statut</button>
        <button onclick="deleteOrder(${o.id})" class="px-3 py-1 bg-red-100 rounded">Supprimer</button>
      </div>`;
    list.appendChild(div);
  });
}

function toggleStatus(id) {
  const o = orders.find(o => o.id === id);
  if (!o) return;
  o.status = o.status === 'pending' ? 'completed' : 'pending';
  save(); render();
}

function deleteOrder(id) {
  const o = orders.find(o => o.id === id);
  if (!o) return;
  o.pokemon.forEach(p => {
    const inv = inventory.find(i => i.id === p.id);
    if (inv) inv.reserved = false;
  });
  orders = orders.filter(o => o.id !== id);
  save(); render();
}

render();
</script>

</body>
</html>