<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>RÃ©servations PokÃ©mon</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
  padding: 20px;
}
h1,h2 { text-align:center; }
.hidden { display:none; }

.section {
  background:white;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.1);
}

.pokemon-card {
  display:flex;
  align-items:center;
  gap:15px;
  margin:12px 0;
  padding:12px;
  border-radius:10px;
  background:#f9fafb;
  transition:transform .2s;
}
.pokemon-card:hover { transform:scale(1.02); }

.pokemon-card img { width:90px; }

.baron {
  border:2px solid gold;
  background:#fffbea;
}

.badge {
  background:gold;
  color:black;
  font-size:12px;
  padding:2px 6px;
  border-radius:6px;
  margin-left:6px;
}

button {
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

button.primary { background:#2563eb; color:white; }
button.primary:disabled { background:#94a3b8; cursor:not-allowed; }

button.red { background:#dc2626; color:white; }
button.gray { background:#64748b; color:white; }

.remove-btn {
  margin-left:auto;
  background:#ef4444;
  color:white;
  border-radius:50%;
  width:32px;
  height:32px;
  font-size:16px;
  line-height:32px;
  text-align:center;
}

input, textarea {
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #cbd5e1;
}
small { color:#475569; }
</style>
</head>

<body>

<h1>ğŸ® RÃ©servations PokÃ©mon</h1>

<!-- ADMIN LOGIN -->
<div class="section">
  <input id="adminCodeInput" type="password" placeholder="Code admin">
  <button id="loginAdminBtn" class="gray">Connexion admin</button>
</div>

<!-- ADMIN -->
<div id="adminView" class="hidden">

  <div class="section">
    <h2>â• Ajouter PokÃ©mon</h2>
    <textarea id="scanInput" rows="4" placeholder="Ex: 2 Pikachu"></textarea>
    <label>
      <input type="checkbox" id="baronCheckbox"> PokÃ©mon Baron ğŸ‘‘
    </label>
    <button id="scanBtn" class="primary">Ajouter</button>
  </div>

  <div class="section">
    <h2>ğŸ“¦ Inventaire</h2>
    <div id="adminInventory"></div>
  </div>

  <div class="section">
    <h2>ğŸ§¾ Commandes en cours</h2>
    <button id="clearOrdersBtn" class="red">ğŸ§¹ Tout effacer</button>
    <div id="ordersList"></div>
  </div>

  <button id="logoutBtn" class="gray">DÃ©connexion</button>
</div>

<!-- CLIENT -->
<div id="clientView">

  <div class="section">
    <h2>ğŸ‘¤ Client</h2>
    <input id="pseudoInput" placeholder="Votre pseudo">
    <button id="validatePseudoBtn" class="primary">Valider le pseudo</button>
    <small id="pseudoStatus"></small>
  </div>

  <div class="section">
    <input id="searchInput" placeholder="ğŸ” Rechercher un PokÃ©mon">
  </div>

  <div class="section">
    <h2>ğŸ¦Š PokÃ©mon disponibles</h2>
    <div id="pokemonList"></div>
  </div>

</div>

<script>
/* ========= CONFIG ========= */
const CONFIG = {
  ADMIN_CODE: "1234",
  MAX_RESERVATIONS: 2,
  START_HOUR: 16,
  END_HOUR: 20,
  END_MINUTE: 30
};

const captureSound = new Audio(
  "https://assets.mixkit.co/active_storage/sfx/212/212-preview.mp3"
);
captureSound.volume = 0.5;

let inventory = JSON.parse(localStorage.getItem("inventory") || "[]");
let reservations = JSON.parse(localStorage.getItem("reservations") || "{}");
let pseudoValidated = false;

/* ========= UTILS ========= */
const save = () => {
  localStorage.setItem("inventory", JSON.stringify(inventory));
  localStorage.setItem("reservations", JSON.stringify(reservations));
};

const isWithinTimeWindow = () => {
  const d = new Date();
  const m = d.getHours()*60 + d.getMinutes();
  return m >= CONFIG.START_HOUR*60 &&
         m <= CONFIG.END_HOUR*60 + CONFIG.END_MINUTE;
};

async function fetchPokemonImage(name) {
  try {
    const r = await fetch(`https://pokeapi.co/api/v2/pokemon/${name.toLowerCase()}`);
    const d = await r.json();
    return d.sprites.other["official-artwork"].front_default;
  } catch {
    return "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png";
  }
}

/* ========= ADMIN ========= */
loginAdminBtn.onclick = () => {
  if (adminCodeInput.value !== CONFIG.ADMIN_CODE) return alert("Code incorrect");
  adminView.classList.remove("hidden");
  clientView.classList.add("hidden");
  renderAdmin();
};

logoutBtn.onclick = () => {
  adminView.classList.add("hidden");
  clientView.classList.remove("hidden");
};

scanBtn.onclick = async () => {
  const isBaron = baronCheckbox.checked;
  const lines = scanInput.value.trim().split("\n");

  for (const line of lines) {
    if (!line) continue;
    const m = line.match(/^(\d+)\s+(.*)$/);
    const qty = m ? +m[1] : 1;
    const name = m ? m[2] : line;
    const img = await fetchPokemonImage(name);
    const e = inventory.find(p => p.name === name && p.baron === isBaron);
    e ? e.quantity += qty
      : inventory.push({ name, image: img, quantity: qty, baron: isBaron });
  }

  scanInput.value = "";
  baronCheckbox.checked = false;
  save(); renderAdmin(); renderClient();
};

clearOrdersBtn.onclick = () => {
  if (confirm("Supprimer toutes les commandes ?")) {
    reservations = {};
    save(); renderAdmin();
  }
};

/* ğŸ”¥ SUPPRESSION AVEC QUANTITÃ‰ */
function removeFromInventory(index) {
  const item = inventory[index];
  const qty = parseInt(
    prompt(`QuantitÃ© Ã  enlever pour ${item.name} (max ${item.quantity}) :`)
  );

  if (isNaN(qty) || qty <= 0) return;

  if (qty >= item.quantity) {
    inventory.splice(index, 1);
  } else {
    item.quantity -= qty;
  }

  save();
  renderAdmin();
  renderClient();
}

function addPokemonToOrder(pseudo) {
  const name = prompt("Nom du PokÃ©mon Ã  ajouter :");
  if (!name || !reservations[pseudo]) return;
  reservations[pseudo].pokemon.push(name);
  save(); renderAdmin();
}

function removeOrder(pseudo) {
  delete reservations[pseudo];
  save(); renderAdmin();
}

/* ========= CLIENT ========= */
validatePseudoBtn.onclick = () => {
  if (!pseudoInput.value.trim()) return alert("Pseudo invalide");
  pseudoValidated = true;
  pseudoStatus.textContent = "âœ… Pseudo validÃ©";
  renderClient();
};

function reservePokemon(name) {
  if (!pseudoValidated) return alert("Valide ton pseudo");
  if (!isWithinTimeWindow()) return alert("RÃ©servations 16h â†’ 20h30");

  const pseudo = pseudoInput.value.trim();
  if (!reservations[pseudo]) reservations[pseudo] = { pokemon: [] };
  if (reservations[pseudo].pokemon.length >= CONFIG.MAX_RESERVATIONS)
    return alert("Limite atteinte");

  const item = inventory.find(p => p.name === name);
  if (!item) return;

  item.quantity--;
  if (!item.quantity) inventory = inventory.filter(p => p !== item);

  reservations[pseudo].pokemon.push(name);
  captureSound.currentTime = 0;
  captureSound.play();

  save(); renderClient();
}

/* ========= RENDER ========= */
searchInput.oninput = renderClient;

function renderAdmin() {
  adminInventory.innerHTML = "";
  inventory.forEach((p, i) => {
    adminInventory.innerHTML += `
      <div class="pokemon-card ${p.baron ? "baron" : ""}">
        <img src="${p.image}">
        <b>${p.name}</b> x${p.quantity}
        ${p.baron ? "<span class='badge'>BARON ğŸ‘‘</span>" : ""}
        <button class="remove-btn" onclick="removeFromInventory(${i})">âœ–</button>
      </div>`;
  });

  ordersList.innerHTML = "";
  Object.keys(reservations).forEach(p => {
    ordersList.innerHTML += `
      <div>
        <b>${p}</b> â†’ ${reservations[p].pokemon.join(", ")}
        <button onclick="addPokemonToOrder('${p}')">â•</button>
        <button class="red" onclick="removeOrder('${p}')">âœ”ï¸</button>
      </div>`;
  });
}

function renderClient() {
  const filter = searchInput.value.toLowerCase();
  pokemonList.innerHTML = "";

  inventory
    .filter(p => p.name.toLowerCase().includes(filter))
    .forEach(p => {
      pokemonList.innerHTML += `
        <div class="pokemon-card ${p.baron ? "baron" : ""}">
          <img src="${p.image}">
          <div>
            <b>${p.name}</b>
            ${p.baron ? "<span class='badge'>BARON ğŸ‘‘</span>" : ""}
            <br>QuantitÃ©: ${p.quantity}
          </div>
          <button class="primary" ${!pseudoValidated ? "disabled" : ""}
            onclick="reservePokemon('${p.name}')">RÃ©server</button>
        </div>`;
    });
}

renderClient();
</script>

</body>
</html>